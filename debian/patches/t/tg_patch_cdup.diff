From: Jiang Xin <jiangxin@ossxp.com>
Subject: [PATCH] t/tg_patch_cdup

tg patch can run under subdir now.

Signed-off-by: Jiang Xin <jiangxin@ossxp.com>

---
 tg-patch.sh |    8 +++++---
 1 files changed, 5 insertions(+), 3 deletions(-)

diff --git a/tg-patch.sh b/tg-patch.sh
index d701c54..bd26b35 100644
--- a/tg-patch.sh
+++ b/tg-patch.sh
@@ -46,17 +46,19 @@ base_rev="$(git rev-parse --short --verify "refs/top-bases/$name" 2>/dev/null)"
 
 setup_pager
 
+cdup="$(git rev-parse --show-cdup)"
+
 cat_file "$topic:.topmsg"
 echo
-[ -n "$(git grep $diff_opts '^[-]--' ${diff_committed_only:+"$name"} -- ".topmsg")" ] || echo '---'
+[ -n "$(git grep $diff_opts '^[-]--' ${diff_committed_only:+"$name"} -- "${cdup}.topmsg")" ] || echo '---'
 
 # Evil obnoxious hack to work around the lack of git diff --exclude
 git_is_stupid="$(mktemp -t tg-patch-changes.XXXXXX)"
-git diff --name-only $diff_opts "$base_rev" ${diff_committed_only:+"$name"} -- |
+git diff --name-only $diff_opts "$base_rev" ${diff_committed_only:+"$name"} -- $cdup |
 	fgrep -vx ".topdeps" |
 	fgrep -vx ".topmsg" >"$git_is_stupid" || : # fgrep likes to fail randomly?
 if [ -s "$git_is_stupid" ]; then
-	cat "$git_is_stupid" | xargs git diff --patch-with-stat $diff_opts "$base_rev" ${diff_committed_only:+"$name"} --
+	cat "$git_is_stupid" | ([ -n "$cdup" ] && cd $cdup ; xargs git diff --patch-with-stat $diff_opts "$base_rev" ${diff_committed_only:+"$name"} --)
 else
 	echo "No changes."
 fi
-- 
tg: (341a371..) t/tg_patch_cdup (depends on: tgmaster)
